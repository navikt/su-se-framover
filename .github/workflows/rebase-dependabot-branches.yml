name: rebase-dependabot-branches.yml
#Auto Rebase Dependabot PRs

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  rebase-dependabot:
    runs-on: ubuntu-latest

    steps:
    - name: Trigger Dependabot rebase on open PRs
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        echo "Fetching Dependabot PRs..."
        prs=$(gh pr list --repo "$REPO" --state open --json number,author --jq '.[] | select(.author.login=="dependabot[bot]") | .number')
        
        if [ -z "$prs" ]; then
          echo "No open Dependabot PRs found."
          exit 0
        fi
        
        failed_prs=()
        
        for pr in $prs; do
          echo "Requesting rebase for PR #$pr..."
          expected_sha=$(gh pr view "$pr" --repo "$REPO" --json headRefOid -q .headRefOid)
        
          if ! gh api \
            -X POST \
            "repos/$REPO/pulls/$pr/update-branch" \
            -f expected_head_sha="$expected_sha"; then
            echo "⚠️ Failed to rebase PR #$pr (likely due to conflicts)."
            failed_prs+=("$pr")
          else
            echo "✅ Successfully requested rebase for PR #$pr"
          fi
        done
        
        if [ ${#failed_prs[@]} -ne 0 ]; then
          echo "The following PRs could not be rebased due to conflicts: ${failed_prs[*]}"
          exit 1
        else
          echo "All Dependabot PRs rebased successfully."
          exit 0
        fi


